name: Q|ery. Web Docs

on:
  push:
    branches:
      - main
    tags:
      - "**[0-9]+.[0-9]+.[0-9]+*"
    paths:
      - examples/docs/**

env:
  CARGO_TERM_COLOR: always

jobs:
  web-docs:
    name: Web Docs
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [22]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      # selecting a toolchain either by action or manual `rustup` calls should happen
      # before the plugin, as the cache uses the current rustc version as its cache key
      - run: rustup toolchain install stable --profile minimal

      - name: Rust Cache Action
        uses: Swatinem/rust-cache@v2

      - name: Assets Cache
        id: query-cache
        uses: actions/cache@v4
        with:
          path: .query/.cache
          key: query-cache-${{ github.run_id }}
          restore-keys: query-cache

      - name: Set token
        env:
          QUERY_WEB_PRIVATE_TOKEN: ${{ secrets.QUERY_WEB_PRIVATE_TOKEN }}
        run: |
          echo "[default] $QUERY_WEB_PRIVATE_TOKEN" > .query/.token

      - name: Set remote URL
        run: |
          sed -i "s|http://localhost:3000|https://qery.io|" .query/Query.toml

      - name: Use pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Create docs
        env:
          RUST_BACKTRACE: full
          RUST_LOG: info
        run: |
          cd examples/docs
          pnpm query task docs

      - name: Deploy to qery.io
        run: |
          cd examples/docs
          pnpm query task deploy
          pnpm query asset dist
